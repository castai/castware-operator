name: Build
on:
  push:
    branches:
      - main
  release:
    types:
      - published
  pull_request:
    branches:
      - main
    types:
      - opened
      - synchronize
      - reopened
      - labeled
  workflow_dispatch:
    inputs:
      chart:
        description: 'Which chart to release'
        required: true
        type: choice
        options:
          - components

jobs:
  build:
    name: Build
    if: github.event_name != 'release' || !contains(github.event.release.tag_name, '-rc')
    runs-on: ubuntu-24.04
    outputs:
      rc_version: ${{ steps.rc_version.outputs.rc_version }}
      release_tag: ${{ steps.set_version.outputs.release_tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Go
        uses: actions/setup-go@v3
        with:
          go-version: 1.25.4

      - name: Cache Go modules
        uses: actions/cache@v3
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-build-${{ hashFiles('**/go.sum') }}
          restore-keys: ${{ runner.os }}-build-

      - name: Set version from git tag or Chart.yaml
        id: set_version
        run: |
          GIT_TAG=$(git describe --tags --exact-match 2>/dev/null || echo "")
          if [ -n "$GIT_TAG" ]; then
            echo "Using git tag: $GIT_TAG"
            echo "RELEASE_TAG=$GIT_TAG" >> $GITHUB_ENV
            echo "release_tag=$GIT_TAG" >> $GITHUB_OUTPUT
          else
            VERSION=$(grep '^version:' charts/castai-castware-operator/Chart.yaml | awk '{print $2}')
            echo "Using Chart.yaml version: $VERSION"
            echo "RELEASE_TAG=$VERSION" >> $GITHUB_ENV
            echo "release_tag=$VERSION" >> $GITHUB_OUTPUT
          fi

      - name: Generate Helm charts
        run: make helm

      - name: Verify charts directory is up-to-date
        run: |
             if ! git diff --exit-code -- charts/; then
               echo "::error ::charts/ is out of sync â€” please commit the updated files."
               git --no-pager diff -- charts/
               exit 1
             fi

      - name: Build Go binary amd64
        run: go build -ldflags "-s -w -X main.GitCommit=$GITHUB_SHA -X main.GitRef=$GITHUB_REF -X main.Version=${RELEASE_TAG:-commit-$GITHUB_SHA}" -o bin/castware-operator-amd64 github.com/castai/castware-operator/cmd
        env:
          GOOS: linux
          GOARCH: amd64
          CGO_ENABLED: 0

      - name: Build Go binary arm64
        run: go build -ldflags "-s -w -X main.GitCommit=$GITHUB_SHA -X main.GitRef=$GITHUB_REF -X main.Version=${RELEASE_TAG:-commit-$GITHUB_SHA}" -o bin/castware-operator-arm64 github.com/castai/castware-operator/cmd
        env:
          GOOS: linux
          GOARCH: arm64
          CGO_ENABLED: 0

      - name: Upload binaries
        uses: actions/upload-artifact@v4
        with:
          name: binaries
          path: bin/
          retention-days: 1

      - name: Test
        run: make test

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Google Artifact Registry
        uses: docker/login-action@v3
        with:
          registry: us-docker.pkg.dev
          username: _json_key
          password: ${{ secrets.ARTIFACT_BUILDER_JSON_KEY }}

      - name: Build and push pr
        if: ${{ github.event_name == 'pull_request' }}
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          platforms: linux/arm64,linux/amd64
          tags: us-docker.pkg.dev/castai-hub/library/castware-operator:${{ github.sha }}

      - name: Build and push release
        if: github.event_name == 'release'
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          platforms: linux/arm64,linux/amd64
          tags: |
            us-docker.pkg.dev/castai-hub/library/castware-operator:${{ env.RELEASE_TAG }}
            us-docker.pkg.dev/castai-hub/library/castware-operator:latest

      - name: Determine RC version
        id: rc_version
        if: github.event_name == 'release'
        run: |
          BASE_VERSION="${RELEASE_TAG#v}"

          INDEX_URL="https://castai.github.io/helm-charts/index.yaml"

          curl -sf "$INDEX_URL" -o /tmp/helm-index.yaml || touch /tmp/helm-index.yaml
          EXISTING_RC=$(grep -oE "version:\s+${BASE_VERSION}-rc[0-9]+" /tmp/helm-index.yaml \
            | grep -oE "[0-9]+$" \
            | sort -n \
            | tail -1)
          if [ -z "$EXISTING_RC" ]; then
            RC_NUM=1
          else
            RC_NUM=$((EXISTING_RC + 1))
          fi

          RC_VERSION="v${BASE_VERSION}-rc${RC_NUM}"
          echo "RC_VERSION=${RC_VERSION}"
          echo "RC_VERSION=${RC_VERSION}" >> $GITHUB_ENV
          echo "rc_version=${RC_VERSION}" >> $GITHUB_OUTPUT

      - name: Build and push RC image
        if: github.event_name == 'release'
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          platforms: linux/arm64,linux/amd64
          tags: us-docker.pkg.dev/castai-hub/library/castware-operator:${{ env.RC_VERSION }}

      - name: Docker pull for fossa main
        if: github.event_name == 'release'
        run: docker pull us-docker.pkg.dev/castai-hub/library/castware-operator:${{ env.RELEASE_TAG }}

      - name: FOSSA scan docker image
        if: github.event_name == 'release'
        continue-on-error: true
        uses: fossas/fossa-action@v1
        with:
          api-key: ${{ secrets.FOSSA_API_KEY }}
          container: us-docker.pkg.dev/castai-hub/library/castware-operator:${{ env.RELEASE_TAG }}

  release_chart_rc:
    name: Release Helm Chart RC
    runs-on: ubuntu-24.04
    if: github.event_name == 'release'
    needs: build
    permissions:
      contents: write
    env:
      RC_VERSION: ${{ needs.build.outputs.rc_version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Release RC chart
        uses: castai/helm-charts/.github/actions/remote-release@24380f1fdd8ca7f33bc82dc04aa29856af567d64
        with:
          helm-charts-repo-token: ${{ secrets.HELM_CHARTS_REPO_TOKEN }}
          source-repo-token: ${{ secrets.BOT_GITHUB_TOKEN }}
          chart-path: "${{ github.workspace }}/charts/castai-castware-operator"
          chart-releaser-configfile: "${{ github.workspace }}/cr.yaml"
          chart-version-from-tag: "true"
          commit-chart-changes: "false"
          sync-chart: "false"
          release-tag: ${{ env.RC_VERSION }}

      - name: Wait for RC version to appear in helm index
        run: |
          INDEX_URL="https://castai.github.io/helm-charts/index.yaml"
          echo "Polling index at: $INDEX_URL"
          for i in $(seq 1 10); do
            INDEX=$(curl -sf "$INDEX_URL" || echo "")
            if echo "$INDEX" | grep -qP "version:\s+${RC_VERSION#v}"; then
              echo "RC version ${RC_VERSION} is visible in the index."
              exit 0
            fi
            echo "Attempt $i/10: not yet visible, waiting 10s..."
            sleep 10
          done
          echo "::error ::RC version ${RC_VERSION} did not appear in the helm index after 100 seconds."
          exit 1

  e2e:
    name: E2E test
    runs-on: ubuntu-24.04
    if: |
      always() &&
      needs.release_chart_rc.result != 'failure' &&
      (
        (github.event_name == 'push' && !startsWith(github.event.head_commit.message, 'HOTFIX')) ||
        (github.event_name == 'release' && !startsWith(github.event.release.name, 'HOTFIX')) ||
        (github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'e2e'))
      )
    needs:
      - build
      - release_chart_rc
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Go
        uses: actions/setup-go@v3
        with:
          go-version: 1.25.4

      - name: Cache Go modules
        uses: actions/cache@v3
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-build-${{ hashFiles('**/go.sum') }}
          restore-keys: ${{ runner.os }}-build-

      - name: Download binaries
        uses: actions/download-artifact@v4
        with:
          name: binaries
          path: bin/

      - name: Make binaries executable
        run: chmod +x bin/*

      - name: Set cluster name
        run: echo "KIND_CLUSTER=castware-operator-e2e" >> $GITHUB_ENV

      - name: Create k8s Kind Cluster
        uses: helm/kind-action@v1.5.0
        with:
          cluster_name: castware-operator-e2e
          node_image: kindest/node:v1.27.3
          kubectl_version: v1.27.3
          config: test/e2e/kind-config.yaml

      - name: Login to Google Artifact Registry
        uses: docker/login-action@v3
        with:
          registry: us-docker.pkg.dev
          username: _json_key
          password: ${{ secrets.ARTIFACT_BUILDER_JSON_KEY }}

      - name: Run E2E tests
        env:
          API_KEY: ${{ secrets.API_KEY }}
          E2E_OPERATOR_IMAGE: >-
            ${{
              github.event_name == 'release'
              && format('us-docker.pkg.dev/castai-hub/library/castware-operator:{0}', needs.build.outputs.rc_version)
              || format('us-docker.pkg.dev/castai-hub/library/castware-operator:{0}', github.sha)
            }}
          E2E_OPERATOR_VERSION: >-
            ${{
              github.event_name == 'release'
              && needs.build.outputs.rc_version
              || github.sha
            }}
        run: make test-e2e

  release_chart_operator:
    name: Release Helm Chart Operator
    runs-on: ubuntu-24.04
    if: |
      github.event_name == 'release' &&
      always() &&
      needs.release_chart_rc.result == 'success' &&
      (needs.e2e.result == 'success' || needs.e2e.result == 'skipped')
    needs:
      - build
      - release_chart_rc
      - e2e
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.BOT_GITHUB_TOKEN }}

      - name: Release castware-operator chart
        uses: castai/helm-charts/.github/actions/remote-release@24380f1fdd8ca7f33bc82dc04aa29856af567d64
        with:
          helm-charts-repo-token: ${{ secrets.HELM_CHARTS_REPO_TOKEN }}
          source-repo-token: ${{ secrets.BOT_GITHUB_TOKEN }}
          chart-path: "${{ github.workspace }}/charts/castai-castware-operator"
          chart-releaser-configfile: "${{ github.workspace }}/cr.yaml"
          chart-version-from-tag: "true"

  release_chart_components:
    name: Release Helm Chart Components
    runs-on: ubuntu-24.04
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.chart == 'components'
    needs: build
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.BOT_GITHUB_TOKEN }}

      - name: Release castware-components chart
        uses: castai/helm-charts/.github/actions/remote-release@24380f1fdd8ca7f33bc82dc04aa29856af567d64
        with:
          helm-charts-repo-token: ${{ secrets.HELM_CHARTS_REPO_TOKEN }}
          source-repo-token: ${{ secrets.BOT_GITHUB_TOKEN }}
          chart-path: "${{ github.workspace }}/charts/castai-castware-components"
          chart-releaser-configfile: "${{ github.workspace }}/cr.yaml"
          chart-version-from-tag: "true"
